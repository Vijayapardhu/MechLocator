{% extends 'base.html' %}
{% load static %}

{% block title %}MechLocator - Find Nearby Mechanic Shops{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .search-panel {
        background: rgba(255, 255, 255, 0.95);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .mechanic-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .mechanic-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .rating-stars {
        color: #ffc107;
    }
    
    .distance-badge {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.9em;
    }
    
    .call-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        border-radius: 25px;
        padding: 10px 25px;
        transition: all 0.3s;
    }
    
    .call-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }
    
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 80px 0;
        margin-bottom: 40px;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-icon {
        font-size: 2.5rem;
        color: #007bff;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 fw-bold mb-4">
            <i class="fas fa-tools me-3"></i>Find the Best Mechanic Near You
        </h1>
        <p class="lead mb-4">Discover trusted mechanic shops in your area with real-time location and instant contact options.</p>
        <div class="row justify-content-center">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <h4 class="fw-bold">{{ mechanics_count }}+</h4>
                    <p class="mb-0">Mechanic Shops</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <h4 class="fw-bold">4.5+</h4>
                    <p class="mb-0">Average Rating</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h4 class="fw-bold">24/7</h4>
                    <p class="mb-0">Search Available</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container">
    <!-- Search Panel -->
    <div class="search-panel">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-3"><i class="fas fa-search me-2"></i>Search Filters</h5>
                <div class="mb-3">
                    <label for="radius" class="form-label">Search Radius</label>
                    <select id="radius" class="form-select">
                        <option value="1">1 km</option>
                        <option value="5">5 km</option>
                        <option value="10" selected>10 km</option>
                        <option value="15">15 km</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="rating" class="form-label">Minimum Rating</label>
                    <select id="rating" class="form-select">
                        <option value="0">Any Rating</option>
                        <option value="3.0">3+ Stars</option>
                        <option value="3.5">3.5+ Stars</option>
                        <option value="4.0">4+ Stars</option>
                        <option value="4.5">4.5+ Stars</option>
                    </select>
                </div>
                <button id="searchBtn" class="btn btn-primary w-100">
                    <i class="fas fa-search me-2"></i>Find Mechanics
                </button>
            </div>
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                    <span id="locationStatus">Click "Find Mechanics" to detect your location</span>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="d-none">
        <h3 class="mb-4">
            <i class="fas fa-list me-2"></i>Nearby Mechanics
            <span id="resultsCount" class="badge bg-primary ms-2">0</span>
        </h3>
        
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Finding mechanics near you...</p>
        </div>
        
        <div id="mechanicsList" class="row g-4"></div>
        
        <div id="noResults" class="text-center py-5 d-none">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No mechanics found</h4>
            <p class="text-muted">Try increasing your search radius or adjusting the rating filter.</p>
        </div>
    </div>

    <!-- Top Mechanics Section -->
    <section class="py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="fw-bold">
                    <i class="fas fa-star me-2"></i>Top Rated Mechanics
                </h2>
                <p class="lead text-muted">Discover our highest-rated mechanic shops</p>
            </div>
            
            <div class="row g-4">
                {% for mechanic in mechanics|slice:":6" %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 mechanic-card shadow-sm">
                        {% if mechanic.image %}
                            <img src="{{ mechanic.image.url }}" class="card-img-top" alt="{{ mechanic.name }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="fas fa-tools fa-3x text-white"></i>
                            </div>
                        {% endif %}
                        
                        <div class="card-body p-4">
                            <h5 class="card-title fw-bold">{{ mechanic.name }}</h5>
                            <p class="card-text text-muted mb-3">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ mechanic.address|truncatechars:50 }}
                            </p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="rating-stars">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= mechanic.rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="ms-2 text-muted">({{ mechanic.rating }})</span>
                                </div>
                                <span class="badge bg-success">{{ mechanic.rating }}â˜…</span>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <a href="{% url 'mechanics:mechanic_detail' mechanic.id %}" class="btn btn-outline-primary">
                                    <i class="fas fa-info-circle me-1"></i>View Details
                                </a>
                                <a href="tel:{{ mechanic.contact }}" class="btn btn-success">
                                    <i class="fas fa-phone me-1"></i>Call Now
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center">
                    <i class="fas fa-tools fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No mechanics available</h4>
                    <p class="text-muted">Check back later for available mechanic shops.</p>
                </div>
                {% endfor %}
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'mechanics:mechanic_list' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-list me-2"></i>View All Mechanics
                </a>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-5">
        <div class="row text-center">
            <div class="col-md-4 mb-4">
                <div class="p-4">
                    <i class="fas fa-location-arrow fa-3x text-primary mb-3"></i>
                    <h4>Real-time Location</h4>
                    <p>Automatically detect your location and find the nearest mechanic shops instantly.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="p-4">
                    <i class="fas fa-phone fa-3x text-success mb-3"></i>
                    <h4>One-Click Calling</h4>
                    <p>Contact mechanics directly with our integrated calling feature - no need to save numbers.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="p-4">
                    <i class="fas fa-filter fa-3x text-info mb-3"></i>
                    <h4>Smart Filtering</h4>
                    <p>Filter by distance, rating, and more to find exactly what you're looking for.</p>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, userMarker, mechanicMarkers = [];
let userLocation = null;

// Initialize Google Maps
function initMap() {
    const defaultLocation = { lat: 40.7128, lng: -74.0060 }; // New York
    
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: defaultLocation,
        styles: [
            {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }
        ]
    });
    
    // Add click listener to map
    map.addListener('click', function(event) {
        setUserLocation(event.latLng.lat(), event.latLng.lng());
    });
}

// Set user location
function setUserLocation(lat, lng) {
    userLocation = { lat: lat, lng: lng };
    
    // Remove existing user marker
    if (userMarker) {
        userMarker.setMap(null);
    }
    
    // Add new user marker
    userMarker = new google.maps.Marker({
        position: userLocation,
        map: map,
        title: 'Your Location',
        icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            scaledSize: new google.maps.Size(32, 32)
        }
    });
    
    // Center map on user location
    map.setCenter(userLocation);
    map.setZoom(14);
    
    document.getElementById('locationStatus').innerHTML = 
        `<strong>Location set:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
}

// Get user's current location
function getCurrentLocation() {
    if (navigator.geolocation) {
        document.getElementById('locationStatus').innerHTML = 
            '<strong>Detecting your location...</strong>';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                setUserLocation(lat, lng);
                searchMechanics();
            },
            function(error) {
                console.error('Geolocation error:', error);
                document.getElementById('locationStatus').innerHTML = 
                    '<strong class="text-danger">Location access denied. Click on the map to set your location.</strong>';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        document.getElementById('locationStatus').innerHTML = 
            '<strong class="text-warning">Geolocation not supported. Click on the map to set your location.</strong>';
    }
}

// Search for mechanics
function searchMechanics() {
    if (!userLocation) {
        alert('Please set your location first by clicking on the map or allowing location access.');
        return;
    }
    
    const radius = document.getElementById('radius').value;
    const rating = document.getElementById('rating').value;
    
    // Show results section and loading
    document.getElementById('resultsSection').classList.remove('d-none');
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('mechanicsList').innerHTML = '';
    document.getElementById('noResults').classList.add('d-none');
    
    // Clear existing markers
    mechanicMarkers.forEach(marker => marker.setMap(null));
    mechanicMarkers = [];
    
    // Make API request
    fetch('{% url "mechanics:search_mechanics_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            latitude: userLocation.lat,
            longitude: userLocation.lng,
            radius: parseInt(radius),
            rating: parseFloat(rating)
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingSpinner').classList.add('d-none');
        
        if (data.success) {
            displayMechanics(data.mechanics);
            document.getElementById('resultsCount').textContent = data.total_found;
        } else {
            throw new Error(data.error || 'Search failed');
        }
    })
    .catch(error => {
        console.error('Search error:', error);
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('noResults').classList.remove('d-none');
        document.getElementById('noResults').querySelector('p').textContent = 
            'An error occurred while searching. Please try again.';
    });
}

// Display mechanics on map and in list
function displayMechanics(mechanics) {
    if (mechanics.length === 0) {
        document.getElementById('noResults').classList.remove('d-none');
        return;
    }
    
    const mechanicsList = document.getElementById('mechanicsList');
    mechanicsList.innerHTML = '';
    
    mechanics.forEach((mechanic, index) => {
        // Add marker to map
        const marker = new google.maps.Marker({
            position: { lat: mechanic.latitude, lng: mechanic.longitude },
            map: map,
            title: mechanic.name,
            label: {
                text: (index + 1).toString(),
                color: 'white',
                fontWeight: 'bold'
            },
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        // Add info window
        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div style="padding: 10px; max-width: 200px;">
                    <h6 style="margin: 0 0 10px 0;">${mechanic.name}</h6>
                    <p style="margin: 0 0 5px 0; font-size: 12px;">${mechanic.address}</p>
                    <p style="margin: 0 0 5px 0; font-size: 12px;">
                        <strong>Rating:</strong> ${mechanic.rating}/5
                    </p>
                    <p style="margin: 0 0 5px 0; font-size: 12px;">
                        <strong>Distance:</strong> ${mechanic.distance} km
                    </p>
                </div>
            `
        });
        
        marker.addListener('click', () => {
            infoWindow.open(map, marker);
        });
        
        mechanicMarkers.push(marker);
        
        // Create mechanic card
        const card = createMechanicCard(mechanic, index + 1);
        mechanicsList.appendChild(card);
    });
    
    // Fit map bounds to show all markers
    if (mechanicMarkers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        mechanicMarkers.forEach(marker => bounds.extend(marker.getPosition()));
        bounds.extend(userLocation);
        map.fitBounds(bounds);
    }
}

// Create mechanic card HTML
function createMechanicCard(mechanic, number) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';
    
    const ratingStars = 'â˜…'.repeat(Math.floor(mechanic.rating)) + 
                       'â˜†'.repeat(5 - Math.floor(mechanic.rating));
    
    col.innerHTML = `
        <div class="card mechanic-card h-100">
            ${mechanic.image_url ? 
                `<img src="${mechanic.image_url}" class="card-img-top" alt="${mechanic.name}" style="height: 200px; object-fit: cover;">` : 
                `<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="fas fa-tools fa-3x text-muted"></i>
                </div>`
            }
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">${number}. ${mechanic.name}</h5>
                    <span class="distance-badge">${mechanic.distance} km</span>
                </div>
                <p class="card-text text-muted mb-2">
                    <i class="fas fa-map-marker-alt me-1"></i>${mechanic.address}
                </p>
                <div class="mb-2">
                    <span class="rating-stars">${ratingStars}</span>
                    <span class="ms-2">${mechanic.rating}/5</span>
                </div>
                <p class="card-text small text-muted mb-3">
                    <i class="fas fa-clock me-1"></i>${mechanic.working_hours}
                </p>
                <div class="d-grid">
                    <a href="tel:${mechanic.contact}" class="btn call-btn" 
                       onclick="logCall(${mechanic.id})">
                        <i class="fas fa-phone me-2"></i>Call Now
                    </a>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Log mechanic call
function logCall(mechanicId) {
    fetch('{% url "mechanics:log_call_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ mechanic_id: mechanicId })
    })
    .catch(error => console.error('Failed to log call:', error));
}

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map when Google Maps API loads
    if (typeof google !== 'undefined') {
        initMap();
    }
    
    // Search button click
    document.getElementById('searchBtn').addEventListener('click', function() {
        if (!userLocation) {
            getCurrentLocation();
        } else {
            searchMechanics();
        }
    });
    
    // Filter change events
    document.getElementById('radius').addEventListener('change', function() {
        if (userLocation) searchMechanics();
    });
    
    document.getElementById('rating').addEventListener('change', function() {
        if (userLocation) searchMechanics();
    });
});

// Handle Google Maps API loading
window.initMap = initMap;
</script>

<!-- Google Maps API -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&v=3.54&region=US&language=en&callback=initMap">
</script>
{% endblock %}
