{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&v=3.54&region=US&language=en"></script>
{{ media }}
{% endblock %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
<style>
    .map-container {
        padding: 20px;
    }
    .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .map-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .map-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    #adminMap {
        width: 100%;
        height: 600px;
    }
    .map-sidebar {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
    }
    .mechanic-marker {
        cursor: pointer;
        padding: 8px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px 0;
        transition: all 0.2s;
    }
    .mechanic-marker:hover {
        background: #f8f9fa;
        border-color: #007cba;
    }
    .mechanic-marker.active {
        background: #007cba;
        color: white;
        border-color: #007cba;
    }
    .filter-controls {
        margin-bottom: 20px;
    }
    .filter-controls label {
        margin-right: 10px;
        font-weight: bold;
    }
    .filter-controls select {
        margin-right: 15px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url 'admin:mechanics_mechanic_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {% trans 'Map View' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="map-container">
        <div class="map-header">
            <h1>{% trans 'Mechanic Map View' %}</h1>
            <div class="map-controls">
                <button onclick="fitBounds()" class="button">{% trans 'Fit All' %}</button>
                <button onclick="clearMarkers()" class="button">{% trans 'Clear' %}</button>
                <a href="{% url 'admin:mechanics_mechanic_changelist' %}" class="button">{% trans 'Back to List' %}</a>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="filter-controls">
            <label>{% trans 'Filter by Rating:' %}</label>
            <select id="ratingFilter" onchange="filterMarkers()" title="Filter by rating">
                <option value="">{% trans 'All Ratings' %}</option>
                <option value="5">5 Stars</option>
                <option value="4">4+ Stars</option>
                <option value="3">3+ Stars</option>
                <option value="2">2+ Stars</option>
                <option value="1">1+ Stars</option>
            </select>
            
            <label>{% trans 'Filter by Status:' %}</label>
            <select id="statusFilter" onchange="filterMarkers()" title="Filter by status">
                <option value="">{% trans 'All Status' %}</option>
                <option value="active">{% trans 'Active Only' %}</option>
                <option value="inactive">{% trans 'Inactive Only' %}</option>
            </select>
        </div>
        
        <!-- Map -->
        <div class="map-wrapper">
            <div id="adminMap"></div>
        </div>
        
        <!-- Sidebar with mechanic list -->
        <div class="map-sidebar">
            <h3>{% trans 'Mechanics on Map' %} (<span id="markerCount">{{ mechanics|length }}</span>)</h3>
            <div id="mechanicList">
                {% for mechanic in mechanics %}
                <div class="mechanic-marker" data-mechanic-id="{{ mechanic.id }}" 
                     data-rating="{{ mechanic.rating }}" data-status="{{ mechanic.is_active|yesno:'active,inactive' }}">
                    <strong>{{ mechanic.name }}</strong>
                    <br><small>{{ mechanic.address|default:"No address" }}</small>
                    <br><small>Rating: {{ mechanic.rating }}/5 | Status: {{ mechanic.is_active|yesno:"Active,Inactive" }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let map;
let markers = [];
let infoWindows = [];

function initMap() {
    // Initialize map centered on a default location (you can adjust this)
    const defaultCenter = { lat: 40.7128, lng: -74.0060 }; // New York City
    
    map = new google.maps.Map(document.getElementById('adminMap'), {
        zoom: 10,
        center: defaultCenter,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });
    
    // Add mechanics to map
    addMechanicsToMap();
    
    // Add click event to mechanic list items
    addMechanicListEvents();
}

function addMechanicsToMap() {
    const mechanics = {{ mechanics|safe }};
    
    mechanics.forEach((mechanic, index) => {
        if (mechanic.latitude && mechanic.longitude) {
            const position = { lat: parseFloat(mechanic.latitude), lng: parseFloat(mechanic.longitude) };
            
            // Create marker
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: mechanic.name,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" fill="${mechanic.is_active ? '#28a745' : '#dc3545'}" stroke="white" stroke-width="2"/>
                            <text x="12" y="16" text-anchor="middle" fill="white" font-size="12" font-weight="bold">${mechanic.rating}</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24)
                }
            });
            
            // Create info window
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; max-width: 250px;">
                        <h4 style="margin: 0 0 10px 0; color: #007cba;">${mechanic.name}</h4>
                        <p style="margin: 5px 0;"><strong>Address:</strong> ${mechanic.address || 'No address'}</p>
                        <p style="margin: 5px 0;"><strong>Contact:</strong> ${mechanic.contact || 'No contact'}</p>
                        <p style="margin: 5px 0;"><strong>Rating:</strong> ${mechanic.rating}/5</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> ${mechanic.is_active ? 'Active' : 'Inactive'}</p>
                        <p style="margin: 5px 0;"><strong>Created:</strong> ${mechanic.created_at}</p>
                        <div style="margin-top: 10px;">
                            <a href="/admin/mechanics/mechanic/${mechanic.id}/change/" target="_blank" 
                               style="background: #007cba; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px;">
                                Edit in Admin
                            </a>
                        </div>
                    </div>
                `
            });
            
            // Add click event to marker
            marker.addListener('click', () => {
                infoWindows.forEach(iw => iw.close());
                infoWindow.open(map, marker);
                
                // Highlight corresponding list item
                document.querySelectorAll('.mechanic-marker').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-mechanic-id="${mechanic.id}"]`).classList.add('active');
            });
            
            markers.push(marker);
            infoWindows.push(infoWindow);
        }
    });
    
    // Fit map to show all markers
    if (markers.length > 0) {
        fitBounds();
    }
}

function addMechanicListEvents() {
    document.querySelectorAll('.mechanic-marker').forEach((item, index) => {
        item.addEventListener('click', () => {
            if (markers[index]) {
                // Close all info windows
                infoWindows.forEach(iw => iw.close());
                
                // Open info window for this mechanic
                infoWindows[index].open(map, markers[index]);
                
                // Center map on this marker
                map.setCenter(markers[index].getPosition());
                map.setZoom(15);
                
                // Highlight list item
                document.querySelectorAll('.mechanic-marker').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            }
        });
    });
}

function filterMarkers() {
    const ratingFilter = document.getElementById('ratingFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    let visibleCount = 0;
    
    document.querySelectorAll('.mechanic-marker').forEach((item, index) => {
        const rating = parseInt(item.dataset.rating);
        const status = item.dataset.status;
        
        let show = true;
        
        // Apply rating filter
        if (ratingFilter && rating < parseInt(ratingFilter)) {
            show = false;
        }
        
        // Apply status filter
        if (statusFilter && status !== statusFilter) {
            show = false;
        }
        
        // Show/hide marker and list item
        if (show) {
            markers[index].setMap(map);
            item.style.display = 'block';
            visibleCount++;
        } else {
            markers[index].setMap(null);
            item.style.display = 'none';
        }
    });
    
    // Update marker count
    document.getElementById('markerCount').textContent = visibleCount;
}

function fitBounds() {
    if (markers.length === 0) return;
    
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(marker => {
        if (marker.getMap()) {
            bounds.extend(marker.getPosition());
        }
    });
    
    if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
        map.setZoom(Math.min(map.getZoom(), 15));
    }
}

function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    infoWindows.forEach(iw => iw.close());
}

// Initialize map when page loads
google.maps.event.addDomListener(window, 'load', initMap);
</script>
{% endblock %}
